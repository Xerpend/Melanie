# Melanie CLI Makefile
# Cross-platform build automation

.PHONY: help install clean build test lint format dev-install package verify

# Default target
help:
	@echo "Melanie CLI Build System"
	@echo ""
	@echo "Available targets:"
	@echo "  install     - Install dependencies"
	@echo "  dev-install - Install development dependencies"
	@echo "  clean       - Clean build artifacts"
	@echo "  build       - Build executable for current platform"
	@echo "  test        - Run tests"
	@echo "  lint        - Run linting"
	@echo "  format      - Format code"
	@echo "  package     - Create distribution package"
	@echo "  verify      - Verify built executable"
	@echo "  all         - Run full build pipeline"

# Install production dependencies
install:
	@echo "ğŸ“¦ Installing dependencies..."
	pip install -r requirements.txt

# Install development dependencies
dev-install: install
	@echo "ğŸ”§ Installing development dependencies..."
	pip install pytest pytest-asyncio black isort mypy

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	python build.py --no-clean
	rm -rf build/ dist/ *.spec
	find . -name "*.pyc" -delete
	find . -name "__pycache__" -delete

# Build executable
build:
	@echo "ğŸ”¨ Building executable..."
	python build.py

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	python -m pytest tests/ -v

# Run code generation workflow tests
test-code-generation:
	@echo "ğŸ§ª Running code generation workflow tests..."
	python -m pytest tests/test_code_generation_workflow.py -v

# Run integration workflow tests
test-integration:
	@echo "ğŸ§ª Running integration workflow tests..."
	python -m pytest tests/test_integration_workflow.py -v

# Run all tests with coverage
test-coverage:
	@echo "ğŸ§ª Running all tests with coverage..."
	python -m pytest tests/ -v --cov=. --cov-report=term-missing --cov-report=html

# Run linting
lint:
	@echo "ğŸ” Running linting..."
	python -m mypy . --ignore-missing-imports
	python -m isort --check-only .
	python -m black --check .

# Format code
format:
	@echo "âœ¨ Formatting code..."
	python -m isort .
	python -m black .

# Create distribution package
package: build
	@echo "ğŸ“¦ Creating distribution package..."
	# Package is created as part of build process

# Verify executable
verify:
	@echo "âœ… Verifying executable..."
	python build.py --verify-only

# Full build pipeline
all: clean dev-install lint test build verify
	@echo "âœ¨ Full build pipeline completed!"

# Platform-specific builds (for CI/CD)
build-macos:
	@echo "ğŸ Building for macOS..."
	python build.py

build-linux:
	@echo "ğŸ§ Building for Linux..."
	python build.py

build-windows:
	@echo "ğŸªŸ Building for Windows..."
	python build.py

# Development targets
dev: dev-install
	@echo "ğŸš€ Development environment ready!"

run-dev:
	@echo "ğŸƒ Running CLI in development mode..."
	python main.py

# Install CLI globally (development)
install-dev:
	@echo "ğŸ”— Installing CLI for development..."
	pip install -e .

# Uninstall CLI
uninstall:
	@echo "ğŸ—‘ï¸  Uninstalling CLI..."
	pip uninstall melanie-cli -y